---
phase: 12-settings-panel-ui
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - frontend/components/settings/settings-panel.tsx
  - frontend/messages/en.json
  - frontend/messages/fr.json
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "OpenAI-compatible form shows base URL, optional API key, and model dropdown"
    - "OpenRouter form shows API key and searchable model dropdown"
    - "User can search/filter 400+ models in OpenRouter dropdown"
    - "Restart prompt appears when saving after provider change"
    - "STT provider info box updates based on selected provider"
  artifacts:
    - path: "frontend/components/settings/settings-panel.tsx"
      provides: "Complete provider forms with all requirements"
      contains: "searchModels"
    - path: "frontend/messages/en.json"
      provides: "English translations for new UI elements"
      contains: "searchModels"
    - path: "frontend/messages/fr.json"
      provides: "French translations for new UI elements"
      contains: "searchModels"
  key_links:
    - from: "settings-panel.tsx"
      to: "cmdk"
      via: "Command component import"
      pattern: "import.*cmdk"
---

<objective>
Implement provider configuration forms and restart prompt UX.

Purpose: Allow users to configure OpenAI-compatible and OpenRouter providers in the settings panel with full functionality including searchable model selection.
Output: Complete provider forms, cmdk-based searchable dropdown for OpenRouter, restart prompt, updated i18n translations.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-settings-panel-ui/12-RESEARCH.md
@.planning/phases/12-settings-panel-ui/12-01-SUMMARY.md
@frontend/components/settings/settings-panel.tsx
@frontend/components/setup/provider-step.tsx
@frontend/messages/en.json
@frontend/messages/fr.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cmdk and add i18n translations</name>
  <files>frontend/package.json, frontend/messages/en.json, frontend/messages/fr.json</files>
  <action>
1. Install cmdk package:
   ```bash
   cd frontend && pnpm add cmdk
   ```

2. Add new i18n keys to en.json under Settings.providers:
   ```json
   "searchModels": "Search models...",
   "noModelsFound": "No models found",
   "restartRequired": "Restart Required",
   "restartDescription": "The LLM provider has changed. Please restart the agent for changes to take effect.",
   "restartLater": "I'll restart later"
   ```

3. Add corresponding keys to fr.json under Settings.providers:
   ```json
   "searchModels": "Rechercher des modeles...",
   "noModelsFound": "Aucun modele trouve",
   "restartRequired": "Redemarrage requis",
   "restartDescription": "Le fournisseur LLM a change. Veuillez redemarrer l'agent pour que les modifications prennent effet.",
   "restartLater": "Je redemarrerai plus tard"
   ```

Note: No accents in values - matches existing fr.json style for technical terms.
  </action>
  <verify>`cd frontend && pnpm build 2>&1 | head -50` and grep for "searchModels" in both json files</verify>
  <done>cmdk installed, i18n keys present in both en.json and fr.json</done>
</task>

<task type="auto">
  <name>Task 2: Add OpenAI-compatible and OpenRouter form sections</name>
  <files>frontend/components/settings/settings-panel.tsx</files>
  <action>
In renderProvidersTab(), after the Groq form section (the closing div before STT Info box), add the two new form sections.

1. Add import at top of file:
   ```typescript
   import { Command } from 'cmdk';
   import { CaretDown } from '@phosphor-icons/react/dist/ssr';
   ```

2. Add state for model dropdown (after test states):
   ```typescript
   const [openrouterDropdownOpen, setOpenrouterDropdownOpen] = useState(false);
   const [openrouterSearch, setOpenrouterSearch] = useState('');
   ```

3. Add OpenAI-compatible form section (after the Groq form section, before STT Info box):
   ```tsx
   {settings.llm_provider === 'openai_compatible' && (
     <div className="space-y-4">
       <div className="space-y-2">
         <label className="text-sm font-medium">{t('providers.baseUrl')}</label>
         <div className="flex gap-2">
           <input
             type="text"
             value={settings.openai_base_url}
             onChange={(e) => setSettings({ ...settings, openai_base_url: e.target.value })}
             placeholder="http://localhost:8000/v1"
             className="input-field text-foreground flex-1 px-4 py-3 text-sm"
           />
           <button
             onClick={testOpenAICompatible}
             disabled={!settings.openai_base_url || openaiTest.status === 'testing'}
             className="flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium transition-colors disabled:opacity-50"
             style={{ background: 'rgb(from var(--surface-2) r g b / 0.5)' }}
           >
             <TestStatusIcon status={openaiTest.status} />
             {tCommon('test')}
           </button>
         </div>
         {openaiTest.error && <p className="text-xs text-red-500">{openaiTest.error}</p>}
         {openaiTest.status === 'success' && (
           <p className="text-xs text-green-500">
             {t('providers.modelsAvailable', { count: openaiModels.length })}
           </p>
         )}
       </div>

       <div className="space-y-2">
         <label className="text-sm font-medium">
           {t('providers.apiKey')} ({t('providers.optional')})
         </label>
         <input
           type="password"
           value={settings.openai_api_key}
           onChange={(e) => setSettings({ ...settings, openai_api_key: e.target.value })}
           placeholder="sk-..."
           className="input-field text-foreground w-full px-4 py-3 text-sm"
         />
         <p className="text-muted-foreground text-xs">{t('providers.openaiApiKeyNote')}</p>
       </div>

       {(openaiModels.length > 0 || settings.openai_model) && (
         <div className="space-y-2">
           <label className="text-sm font-medium">{t('providers.model')}</label>
           <select
             value={settings.openai_model}
             onChange={(e) => setSettings({ ...settings, openai_model: e.target.value })}
             className="select-field text-foreground w-full px-4 py-3 text-sm"
           >
             {openaiModels.length > 0 ? (
               <>
                 <option value="">{t('providers.selectModel')}</option>
                 {openaiModels.map((model) => (
                   <option key={model} value={model}>
                     {model}
                   </option>
                 ))}
               </>
             ) : (
               <option value={settings.openai_model}>{settings.openai_model}</option>
             )}
           </select>
           {openaiModels.length === 0 && settings.openai_model && (
             <p className="text-muted-foreground text-xs">{t('providers.testConnectionToSee')}</p>
           )}
         </div>
       )}
     </div>
   )}
   ```

4. Add OpenRouter form section (after OpenAI-compatible section):
   ```tsx
   {settings.llm_provider === 'openrouter' && (
     <div className="space-y-4">
       <div className="space-y-2">
         <label className="text-sm font-medium">{t('providers.apiKey')}</label>
         <div className="flex gap-2">
           <input
             type="password"
             value={settings.openrouter_api_key}
             onChange={(e) => setSettings({ ...settings, openrouter_api_key: e.target.value })}
             placeholder="sk-or-..."
             className="input-field text-foreground flex-1 px-4 py-3 text-sm"
           />
           <button
             onClick={testOpenRouter}
             disabled={!settings.openrouter_api_key || openrouterTest.status === 'testing'}
             className="flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium transition-colors disabled:opacity-50"
             style={{ background: 'rgb(from var(--surface-2) r g b / 0.5)' }}
           >
             <TestStatusIcon status={openrouterTest.status} />
             {tCommon('test')}
           </button>
         </div>
         {openrouterTest.error && <p className="text-xs text-red-500">{openrouterTest.error}</p>}
         {openrouterTest.status === 'success' && (
           <p className="text-xs text-green-500">
             {t('providers.modelsAvailable', { count: openrouterModels.length })}
           </p>
         )}
         <p className="text-muted-foreground text-xs">
           {t('providers.getApiKeyAt')}{' '}
           <a
             href="https://openrouter.ai/keys"
             target="_blank"
             rel="noopener noreferrer"
             className="text-primary underline"
           >
             openrouter.ai
           </a>
         </p>
       </div>

       {(openrouterModels.length > 0 || settings.openrouter_model) && (
         <div className="space-y-2">
           <label className="text-sm font-medium">{t('providers.model')}</label>
           <div className="relative">
             <button
               onClick={() => setOpenrouterDropdownOpen(!openrouterDropdownOpen)}
               className="input-field text-foreground flex w-full items-center justify-between px-4 py-3 text-left text-sm"
             >
               <span className={settings.openrouter_model ? '' : 'text-muted-foreground'}>
                 {settings.openrouter_model || t('providers.selectModel')}
               </span>
               <CaretDown className="h-4 w-4" />
             </button>

             {openrouterDropdownOpen && (
               <div
                 className="absolute z-50 mt-1 w-full overflow-hidden rounded-xl border shadow-lg"
                 style={{ background: 'var(--surface-2)', borderColor: 'var(--border-subtle)' }}
               >
                 <Command shouldFilter={false}>
                   <Command.Input
                     value={openrouterSearch}
                     onValueChange={setOpenrouterSearch}
                     placeholder={t('providers.searchModels')}
                     className="w-full border-b px-4 py-3 text-sm outline-none"
                     style={{ background: 'transparent', borderColor: 'var(--border-subtle)' }}
                   />
                   <Command.List className="max-h-60 overflow-y-auto p-1">
                     <Command.Empty className="text-muted-foreground py-6 text-center text-sm">
                       {t('providers.noModelsFound')}
                     </Command.Empty>
                     {openrouterModels
                       .filter((model) =>
                         model.toLowerCase().includes(openrouterSearch.toLowerCase())
                       )
                       .map((model) => (
                         <Command.Item
                           key={model}
                           value={model}
                           onSelect={() => {
                             setSettings({ ...settings, openrouter_model: model });
                             setOpenrouterDropdownOpen(false);
                             setOpenrouterSearch('');
                           }}
                           className="hover:bg-muted cursor-pointer rounded-md px-3 py-2 text-sm"
                         >
                           {model}
                         </Command.Item>
                       ))}
                   </Command.List>
                 </Command>
               </div>
             )}
           </div>
           {openrouterModels.length === 0 && settings.openrouter_model && (
             <p className="text-muted-foreground text-xs">{t('providers.enterApiKeyToSee')}</p>
           )}
         </div>
       )}
     </div>
   )}
   ```

5. Update the STT Info box to include new providers:
   Replace the existing STT Info box condition to handle all 4 providers:
   ```tsx
   <div className="rounded-lg border border-blue-500/30 bg-blue-500/10 p-3">
     <p className="text-sm text-blue-200">
       <span className="font-semibold">{t('providers.sttProvider')}:</span>{' '}
       {settings.llm_provider === 'ollama' || settings.llm_provider === 'openai_compatible'
         ? t('providers.speachesLocal')
         : t('providers.groqWhisper')}
       <br />
       <span className="text-xs opacity-70">{t('providers.sttProviderNote')}</span>
     </p>
   </div>
   ```
  </action>
  <verify>`cd frontend && pnpm build 2>&1 | head -50` and `pnpm lint`</verify>
  <done>Both provider forms render with all required fields, OpenRouter has searchable dropdown with cmdk, STT info updates correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add restart prompt when provider changes</name>
  <files>frontend/components/settings/settings-panel.tsx</files>
  <action>
Add state and logic to show restart prompt when the LLM provider has changed.

1. Add state for tracking original provider and restart prompt (after other state declarations):
   ```typescript
   const [originalProvider, setOriginalProvider] = useState<string | null>(null);
   const [showRestartPrompt, setShowRestartPrompt] = useState(false);
   ```

2. Add useEffect to capture original provider when settings load (after settingsLoadedFromApi effect):
   ```typescript
   // Capture original provider when settings first load
   useEffect(() => {
     if (settingsLoadedFromApi && originalProvider === null) {
       setOriginalProvider(settings.llm_provider);
     }
   }, [settingsLoadedFromApi, settings.llm_provider, originalProvider]);
   ```

3. Update handleSave function to check for provider change before closing:
   At the end of the try block in handleSave, replace `onClose();` with:
   ```typescript
   // Check if provider changed and show restart prompt instead of closing
   if (settings.llm_provider !== originalProvider && originalProvider !== null) {
     setShowRestartPrompt(true);
   } else {
     onClose();
   }
   ```

4. Add restart prompt UI in the main content area (after error display, before tab content):
   ```tsx
   {showRestartPrompt && (
     <div className="mb-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10 p-4">
       <p className="text-sm font-medium text-yellow-200">
         {t('providers.restartRequired')}
       </p>
       <p className="mt-1 text-xs text-yellow-200/70">
         {t('providers.restartDescription')}
       </p>
       <div className="mt-3 flex gap-2">
         <button
           onClick={onClose}
           className="rounded-md px-3 py-1.5 text-sm font-medium transition-colors"
           style={{ background: 'rgb(from var(--surface-2) r g b / 0.5)' }}
         >
           {t('providers.restartLater')}
         </button>
       </div>
     </div>
   )}
   ```

5. Reset restart prompt state when panel opens (in loadSettings or as separate effect):
   Add to the beginning of loadSettings function:
   ```typescript
   setShowRestartPrompt(false);
   setOriginalProvider(null);
   ```
  </action>
  <verify>`cd frontend && pnpm build 2>&1 | head -50` - no errors</verify>
  <done>Restart prompt appears after saving when provider has changed, allows user to dismiss and close panel</done>
</task>

</tasks>

<verification>
1. `cd frontend && pnpm build` completes without errors
2. `cd frontend && pnpm lint` passes
3. OpenAI-compatible form displays base URL, API key, and model fields
4. OpenRouter form displays API key and searchable model dropdown
5. Searching in OpenRouter dropdown filters the 400+ models
6. Restart prompt appears when saving after provider change
7. i18n keys exist in both en.json and fr.json
</verification>

<success_criteria>
- cmdk installed as dependency
- OpenAI-compatible form with base URL, optional API key, model dropdown
- OpenRouter form with API key, searchable model dropdown using cmdk
- Model search filters work correctly
- Restart prompt shows when provider changes and save is clicked
- All new strings have English and French translations
- STT info box shows correct provider based on LLM selection
</success_criteria>

<output>
After completion, create `.planning/phases/12-settings-panel-ui/12-02-SUMMARY.md`
</output>
